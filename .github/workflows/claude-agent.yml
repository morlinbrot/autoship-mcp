name: Claude Agent

on:
  # Run every 6 hours
  schedule:
    - cron: "0 */6 * * *"

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      prompt_override:
        description: "Custom prompt for Claude (optional)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  work-on-todos:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install MCP server dependencies
        run: |
          cd mcp-servers/todo-db
          npm ci

      - name: Build MCP server
        run: |
          cd mcp-servers/todo-db
          npm run build

      - name: Configure git
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"

      - name: Run Claude Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Default prompt
          PROMPT="You are an autonomous coding agent. Your job is to:

          1. Use the list_pending_todos tool to see available tasks
          2. If there are pending todos, pick the highest priority one
          3. Use claim_todo to mark it as in progress
          4. Read the todo description carefully and implement the requested changes
          5. Create a new git branch with a descriptive name (e.g., 'agent/add-logout-button')
          6. Make the necessary code changes
          7. Commit your changes with a clear commit message
          8. Use complete_todo to mark the task as done, including the branch name
          9. If you encounter an error you cannot resolve, use fail_todo with a clear explanation
          10. If you need clarification, use ask_question to ask and the todo will be blocked until answered

          Important guidelines:
          - Only work on ONE todo per run
          - Make minimal, focused changes
          - Write clean, well-tested code
          - If a task is unclear, use ask_question rather than guessing
          - Check check_answered_questions if working on a previously blocked todo

          Start by listing the pending todos."

          # Use override if provided
          if [ -n "${{ inputs.prompt_override }}" ]; then
            PROMPT="${{ inputs.prompt_override }}"
          fi

          npx @anthropic-ai/claude-code --print "$PROMPT"

      - name: Push branch if created
        run: |
          # Check if we're on a new branch (not main)
          CURRENT_BRANCH=$(git branch --show-current)
          if [ "$CURRENT_BRANCH" != "main" ] && [ -n "$CURRENT_BRANCH" ]; then
            echo "Pushing branch: $CURRENT_BRANCH"
            git push -u origin "$CURRENT_BRANCH"

            # Create PR using GitHub CLI
            gh pr create \
              --title "$(git log -1 --pretty=%s)" \
              --body "This PR was created by the Claude Agent.

          See the agent_todos table in Supabase for task details." \
              --base main \
              --head "$CURRENT_BRANCH" || echo "PR may already exist"
          else
            echo "No new branch to push"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
