name: Claude Agent

on:
  # Run every 5 minutes
  schedule:
    - cron: "*/5 * * * *"

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      prompt_override:
        description: "Custom prompt for Claude (optional)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  check-pending-tasks:
    runs-on: ubuntu-latest
    outputs:
      has_pending_tasks: ${{ steps.check.outputs.has_pending_tasks }}
    steps:
      - name: Check for pending tasks
        id: check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "Checking for pending tasks..."
          RESPONSE=$(curl -s \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            "$SUPABASE_URL/rest/v1/agent_tasks?status=eq.pending&select=id&limit=1")

          echo "Response: $RESPONSE"

          # Check if response is a non-empty array
          if [ "$RESPONSE" != "[]" ] && [ -n "$RESPONSE" ]; then
            echo "Found pending tasks"
            echo "has_pending_tasks=true" >> $GITHUB_OUTPUT
          else
            echo "No pending tasks found"
            echo "has_pending_tasks=false" >> $GITHUB_OUTPUT
          fi

  work-on-tasks:
    runs-on: ubuntu-latest
    needs: check-pending-tasks
    if: needs.check-pending-tasks.outputs.has_pending_tasks == 'true'
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Configure git
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"

      - name: Run Claude Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          set -e

          # Download the agent script and its package.json
          mkdir -p /tmp/autoship-agent

          echo "Downloading agent script..."
          curl -fSL https://raw.githubusercontent.com/morlinbrot/autoship-mcp/main/scripts/claude-agent.js -o /tmp/autoship-agent/claude-agent.js

          echo "Downloading package.json..."
          curl -fSL https://raw.githubusercontent.com/morlinbrot/autoship-mcp/main/scripts/package.json -o /tmp/autoship-agent/package.json

          # Install dependencies
          echo "Installing dependencies..."
          cd /tmp/autoship-agent
          npm install

          # Run the agent (from the original repo directory)
          cd $GITHUB_WORKSPACE
          echo "Starting Claude Agent..."
          if [ -n "${{ inputs.prompt_override }}" ]; then
            node /tmp/autoship-agent/claude-agent.js "${{ inputs.prompt_override }}"
          else
            node /tmp/autoship-agent/claude-agent.js
          fi

      - name: Push branch if created
        run: |
          # Check if we're on a new branch (not main)
          CURRENT_BRANCH=$(git branch --show-current)
          if [ "$CURRENT_BRANCH" != "main" ] && [ -n "$CURRENT_BRANCH" ]; then
            echo "Pushing branch: $CURRENT_BRANCH"
            git push -u origin "$CURRENT_BRANCH"

            # Create PR using GitHub CLI
            echo "Creating PR for branch: $CURRENT_BRANCH"
            if gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' | grep -q .; then
              echo "PR already exists for this branch"
            else
              gh pr create \
                --title "$(git log -1 --pretty=%s)" \
                --body "This PR was created by the Claude Agent.

          See the agent_tasks table in Supabase for task details." \
                --base main \
                --head "$CURRENT_BRANCH"
              echo "PR created successfully"
            fi
          else
            echo "No new branch to push"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
